<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Parliamentary Questions Dashboard - Oireachtas API</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        .chart-container { height: 300px; }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }
        .glass-effect { backdrop-filter: blur(10px); background-color: rgba(255, 255, 255, 0.9); }
        @media print {
            .no-print { display: none; }
            body { font-size: 12px; }
            .chart-container { height: 250px; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- Header -->
    <header class="glass-effect border-b border-white/20 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-building text-2xl text-green-600"></i>
                    <h1 class="text-2xl font-bold text-gray-800">Live Parliamentary Questions Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="apiStatus" class="flex items-center space-x-2">
                        <i id="statusIcon" class="fas fa-circle text-sm"></i>
                        <span id="statusText" class="text-sm font-medium">Connecting...</span>
                    </div>
                    <button id="wordCloudBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-cloud mr-2"></i>Word Cloud
                    </button>
                    <button id="refreshBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Total Questions</p>
                        <p id="totalQuestions" class="text-2xl font-bold text-gray-800">Loading...</p>
                    </div>
                    <i class="fas fa-question-circle text-3xl text-green-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Active Deputies</p>
                        <p id="activeDeputies" class="text-2xl font-bold text-gray-800">Loading...</p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Departments</p>
                        <p id="activeDepartments" class="text-2xl font-bold text-gray-800">Loading...</p>
                    </div>
                    <i class="fas fa-building text-3xl text-yellow-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Last Updated</p>
                        <p id="lastUpdated" class="text-sm font-medium text-gray-800">Never</p>
                    </div>
                    <i class="fas fa-clock text-3xl text-purple-500"></i>
                </div>
            </div>
        </div>

        <!-- Filters Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-filter mr-2 text-green-600"></i>Filters & Search
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date From</label>
                    <input type="date" id="dateFrom" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date To</label>
                    <input type="date" id="dateTo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                    <select id="departmentFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deputy</label>
                    <select id="deputyFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">All Deputies</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select id="typeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">All Types</option>
                        <option value="oral">Oral</option>
                        <option value="written">Written</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="clearFilters" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-eraser mr-2"></i>Clear
                    </button>
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Search Questions</label>
                <input type="text" id="searchInput" placeholder="Search in question text..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>
        </div>

        <!-- Auto-refresh Settings -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-sync-alt mr-2 text-green-600"></i>Auto-refresh Settings
            </h3>
            <div class="flex flex-wrap gap-4 items-center">
                <label class="flex items-center space-x-2">
                    <input type="radio" name="autoRefresh" value="0" checked class="text-green-600">
                    <span class="text-sm">Manual</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="autoRefresh" value="300000" class="text-green-600">
                    <span class="text-sm">5 minutes</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="autoRefresh" value="900000" class="text-green-600">
                    <span class="text-sm">15 minutes</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="autoRefresh" value="1800000" class="text-green-600">
                    <span class="text-sm">30 minutes</span>
                </label>
                <div id="refreshTimer" class="text-sm text-gray-600 ml-auto"></div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Department Distribution -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-pie mr-2 text-green-600"></i>Questions by Department
                </h3>
                <div class="chart-container">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>

            <!-- Question Types -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-donut mr-2 text-blue-600"></i>Question Types Distribution
                </h3>
                <div class="chart-container">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>

            <!-- Top Deputies -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-bar mr-2 text-yellow-600"></i>Most Active Deputies
                </h3>
                <div class="chart-container">
                    <canvas id="deputyChart"></canvas>
                </div>
            </div>

            <!-- Weekly Question Trends -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-purple-600"></i>Weekly Question Trends
                </h3>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Weekly Trends Analytics -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-purple-600"></i>Weekly Question Trends & Analytics
                </h3>
            </div>
            
            <!-- Weekly Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm">Peak Day</p>
                            <p id="peakDay" class="text-xl font-bold">Thursday</p>
                        </div>
                        <i class="fas fa-calendar-day text-2xl text-blue-200"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-4 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm">Weekly Avg</p>
                            <p id="weeklyAvg" class="text-xl font-bold">143</p>
                        </div>
                        <i class="fas fa-chart-bar text-2xl text-green-200"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg p-4 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-yellow-100 text-sm">Trend</p>
                            <p id="trendStatus" class="text-xl font-bold">Stable</p>
                        </div>
                        <i class="fas fa-arrow-right text-2xl text-yellow-200"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm">Consistency</p>
                            <p id="consistencyScore" class="text-xl font-bold">High</p>
                        </div>
                        <i class="fas fa-balance-scale text-2xl text-purple-200"></i>
                    </div>
                </div>
            </div>

            <!-- Weekly Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">Daily Activity Pattern</h4>
                    <div style="height: 200px;">
                        <canvas id="dailyPatternChart"></canvas>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">Question Type by Day</h4>
                    <div style="height: 200px;">
                        <canvas id="typeByDayChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Questions Feed -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-stream mr-2 text-green-600"></i>Recent Questions
                </h3>
                <div class="flex space-x-2">
                    <button id="exportCsv" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <button id="exportJson" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                        <i class="fas fa-download mr-2"></i>Export JSON
                    </button>
                </div>
            </div>
            
            <!-- Deputy Search -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Search by Deputy</label>
                <div class="flex gap-2">
                    <input type="text" id="deputySearch" placeholder="Search deputy name..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <button id="clearDeputySearch" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="deputySuggestions" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto"></div>
            </div>
            
            <div id="questionsTable" class="overflow-x-auto">
                <div class="flex justify-center items-center py-8">
                    <i class="fas fa-spinner loading-spinner text-2xl text-gray-400 mr-3"></i>
                    <span class="text-gray-600">Loading questions...</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Word Cloud Modal -->
    <div id="wordCloudModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Word Cloud Analysis</h3>
                <button id="closeWordCloudModal" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Department</label>
                    <select id="wordCloudDepartment" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div id="wordCloudContainer" class="min-h-96 border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <div class="flex justify-center items-center py-8">
                        <i class="fas fa-spinner loading-spinner text-2xl text-gray-400 mr-3"></i>
                        <span class="text-gray-600">Generating word cloud...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Modal -->
    <div id="questionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Question Details</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalContent" class="p-6">
                <!-- Question details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-30 hidden items-center justify-center z-40">
        <div class="bg-white rounded-xl p-6 flex items-center space-x-4 shadow-2xl">
            <i class="fas fa-spinner loading-spinner text-2xl text-green-600"></i>
            <span class="text-lg font-medium text-gray-800">Loading data...</span>
        </div>
    </div>

    <script>
        class ParliamentaryDashboard {
            constructor() {
                this.baseURL = 'https://api.oireachtas.ie/v1/questions';
                this.data = [];
                this.filteredData = [];
                this.charts = {};
                this.refreshInterval = null;
                this.cache = new Map();
                this.lastFetchTime = null;
                this.isLoading = false;
                this.selectedDeputy = null;
                
                this.init();
            }

            async init() {
                this.setupEventListeners();
                this.setupDateInputs();
                await this.fetchData();
                this.setupAutoRefresh();
            }

            setupEventListeners() {
                // Refresh button
                document.getElementById('refreshBtn').addEventListener('click', () => this.fetchData());

                // Word Cloud button
                document.getElementById('wordCloudBtn').addEventListener('click', () => this.openWordCloudModal());

                // Filters
                document.getElementById('dateFrom').addEventListener('change', () => this.applyFilters());
                document.getElementById('dateTo').addEventListener('change', () => this.applyFilters());
                document.getElementById('departmentFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('deputyFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('typeFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('searchInput').addEventListener('input', this.debounce(() => this.applyFilters(), 300));
                document.getElementById('clearFilters').addEventListener('click', () => this.clearAllFilters());

                // Deputy search
                document.getElementById('deputySearch').addEventListener('input', this.debounce(() => this.handleDeputySearch(), 300));
                document.getElementById('clearDeputySearch').addEventListener('click', () => this.clearDeputySearch());

                // Auto-refresh
                document.querySelectorAll('input[name="autoRefresh"]').forEach(radio => {
                    radio.addEventListener('change', () => this.setupAutoRefresh());
                });

                // Export buttons
                document.getElementById('exportCsv').addEventListener('click', () => this.exportData('csv'));
                document.getElementById('exportJson').addEventListener('click', () => this.exportData('json'));

                // Modals
                document.getElementById('closeModal').addEventListener('click', () => this.closeModal());
                document.getElementById('closeWordCloudModal').addEventListener('click', () => this.closeWordCloudModal());
                document.getElementById('questionModal').addEventListener('click', (e) => {
                    if (e.target.id === 'questionModal') this.closeModal();
                });
                document.getElementById('wordCloudModal').addEventListener('click', (e) => {
                    if (e.target.id === 'wordCloudModal') this.closeWordCloudModal();
                });

                // Word cloud department filter
                document.getElementById('wordCloudDepartment').addEventListener('change', () => this.generateWordCloud());
            }

            setupDateInputs() {
                const today = new Date();
                const oneMonthAgo = new Date(today);
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                
                document.getElementById('dateTo').value = today.toISOString().split('T')[0];
                document.getElementById('dateFrom').value = oneMonthAgo.toISOString().split('T')[0];
            }

            async fetchData() {
                if (this.isLoading) return;

                this.isLoading = true;
                this.showLoading(true);
                this.updateStatus('Fetching...', 'loading');

                try {
                    const dateFrom = document.getElementById('dateFrom').value;
                    const dateTo = document.getElementById('dateTo').value;
                    
                    let url = `${this.baseURL}?limit=1000`;
                    if (dateFrom) url += `&date_start=${dateFrom}`;
                    if (dateTo) url += `&date_end=${dateTo}`;

                    const cacheKey = url;
                    if (this.cache.has(cacheKey) && Date.now() - this.cache.get(cacheKey).timestamp < 300000) {
                        this.data = this.cache.get(cacheKey).data;
                    } else {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        
                        const result = await response.json();
                        this.data = result.results || [];
                        
                        // Cache the result
                        this.cache.set(cacheKey, {
                            data: this.data,
                            timestamp: Date.now()
                        });
                    }

                    this.lastFetchTime = new Date();
                    this.updateStatus('Connected', 'online');
                    this.updateStats();
                    this.populateFilters();
                    this.applyFilters();

                } catch (error) {
                    console.error('Error fetching data:', error);
                    this.updateStatus('Connection Error', 'offline');
                    this.showError('Failed to fetch data from API. Please try again.');
                } finally {
                    this.isLoading = false;
                    this.showLoading(false);
                }
            }

            updateStatus(text, status) {
                const statusIcon = document.getElementById('statusIcon');
                const statusText = document.getElementById('statusText');
                
                statusIcon.className = 'fas fa-circle text-sm';
                statusText.textContent = text;

                if (status === 'online') {
                    statusIcon.classList.add('status-online');
                    statusIcon.classList.remove('status-offline');
                } else if (status === 'offline') {
                    statusIcon.classList.add('status-offline');
                    statusIcon.classList.remove('status-online');
                } else {
                    statusIcon.className = 'fas fa-spinner loading-spinner text-sm text-yellow-500';
                }
            }

            updateStats() {
                const totalQuestions = this.data.length;
                const uniqueDeputies = new Set(this.data.map(item => item.question.by.showAs)).size;
                const uniqueDepartments = new Set(this.data.map(item => item.question.to?.showAs).filter(Boolean)).size;

                document.getElementById('totalQuestions').textContent = totalQuestions.toLocaleString();
                document.getElementById('activeDeputies').textContent = uniqueDeputies;
                document.getElementById('activeDepartments').textContent = uniqueDepartments;
                document.getElementById('lastUpdated').textContent = this.lastFetchTime ? 
                    this.lastFetchTime.toLocaleString() : 'Never';
            }

            populateFilters() {
                // Populate department filter
                const departments = [...new Set(this.data.map(item => item.question.to?.showAs).filter(Boolean))].sort();
                const deptSelect = document.getElementById('departmentFilter');
                deptSelect.innerHTML = '<option value="">All Departments</option>';
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    deptSelect.appendChild(option);
                });

                // Populate word cloud department filter
                const wordCloudDeptSelect = document.getElementById('wordCloudDepartment');
                wordCloudDeptSelect.innerHTML = '<option value="">All Departments</option>';
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    wordCloudDeptSelect.appendChild(option);
                });

                // Populate deputy filter (top 50 most active)
                const deputyCounts = {};
                this.data.forEach(item => {
                    const deputy = item.question.by.showAs;
                    deputyCounts[deputy] = (deputyCounts[deputy] || 0) + 1;
                });

                const topDeputies = Object.entries(deputyCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 50)
                    .map(([name]) => name);

                const deputySelect = document.getElementById('deputyFilter');
                deputySelect.innerHTML = '<option value="">All Deputies</option>';
                topDeputies.forEach(deputy => {
                    const option = document.createElement('option');
                    option.value = deputy;
                    option.textContent = deputy;
                    deputySelect.appendChild(option);
                });
            }

            handleDeputySearch() {
                const searchTerm = document.getElementById('deputySearch').value.toLowerCase();
                if (searchTerm.length < 2) {
                    this.selectedDeputy = null;
                    this.applyFilters();
                    return;
                }

                const deputies = [...new Set(this.data.map(item => item.question.by.showAs))]
                    .filter(deputy => deputy.toLowerCase().includes(searchTerm))
                    .slice(0, 10);

                const suggestions = document.getElementById('deputySuggestions');
                if (deputies.length > 0) {
                    suggestions.innerHTML = deputies.map(deputy => 
                        `<div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="dashboard.selectDeputy('${deputy}')">${deputy}</div>`
                    ).join('');
                    suggestions.classList.remove('hidden');
                } else {
                    suggestions.classList.add('hidden');
                }

                // If exact match, filter immediately
                const exactMatch = deputies.find(deputy => deputy.toLowerCase() === searchTerm);
                if (exactMatch) {
                    this.selectedDeputy = exactMatch;
                    this.applyFilters();
                }
            }

            selectDeputy(deputy) {
                this.selectedDeputy = deputy;
                document.getElementById('deputySearch').value = deputy;
                document.getElementById('deputySuggestions').classList.add('hidden');
                this.applyFilters();
            }

            clearDeputySearch() {
                this.selectedDeputy = null;
                document.getElementById('deputySearch').value = '';
                document.getElementById('deputySuggestions').classList.add('hidden');
                this.applyFilters();
            }

            applyFilters() {
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                const department = document.getElementById('departmentFilter').value;
                const deputy = document.getElementById('deputyFilter').value;
                const type = document.getElementById('typeFilter').value;
                const search = document.getElementById('searchInput').value.toLowerCase();

                this.filteredData = this.data.filter(item => {
                    const questionDate = item.question.date;
                    const questionDept = item.question.to?.showAs || '';
                    const questionDeputy = item.question.by.showAs;
                    const questionType = item.question.questionType;
                    const questionText = item.question.showAs.toLowerCase();

                    if (dateFrom && questionDate < dateFrom) return false;
                    if (dateTo && questionDate > dateTo) return false;
                    if (department && questionDept !== department) return false;
                    if (deputy && questionDeputy !== deputy) return false;
                    if (type && questionType !== type) return false;
                    if (search && !questionText.includes(search)) return false;
                    if (this.selectedDeputy && questionDeputy !== this.selectedDeputy) return false;

                    return true;
                });

                this.updateCharts();
                this.updateQuestionsTable();
                this.updateWeeklyAnalytics();
            }

            updateCharts() {
                this.updateDepartmentChart();
                this.updateTypeChart();
                this.updateDeputyChart();
                this.updateWeeklyChart();
            }

            updateDepartmentChart() {
                const ctx = document.getElementById('departmentChart').getContext('2d');
                
                if (this.charts.department) {
                    this.charts.department.destroy();
                }

                const deptCounts = {};
                this.filteredData.forEach(item => {
                    const dept = item.question.to?.showAs || 'Unknown';
                    deptCounts[dept] = (deptCounts[dept] || 0) + 1;
                });

                const sortedDepts = Object.entries(deptCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                this.charts.department = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sortedDepts.map(([name]) => name),
                        datasets: [{
                            data: sortedDepts.map(([, count]) => count),
                            backgroundColor: [
                                '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6',
                                '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6b7280'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }

            updateTypeChart() {
                const ctx = document.getElementById('typeChart').getContext('2d');
                
                if (this.charts.type) {
                    this.charts.type.destroy();
                }

                const typeCounts = {};
                this.filteredData.forEach(item => {
                    const type = item.question.questionType;
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });

                this.charts.type = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(typeCounts),
                        datasets: [{
                            data: Object.values(typeCounts),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            updateDeputyChart() {
                const ctx = document.getElementById('deputyChart').getContext('2d');
                
                if (this.charts.deputy) {
                    this.charts.deputy.destroy();
                }

                const deputyCounts = {};
                this.filteredData.forEach(item => {
                    const deputy = item.question.by.showAs;
                    deputyCounts[deputy] = (deputyCounts[deputy] || 0) + 1;
                });

                const topDeputies = Object.entries(deputyCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                this.charts.deputy = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topDeputies.map(([name]) => name.length > 20 ? name.substring(0, 20) + '...' : name),
                        datasets: [{
                            label: 'Questions Asked',
                            data: topDeputies.map(([, count]) => count),
                            backgroundColor: '#f59e0b'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            updateWeeklyChart() {
                const ctx = document.getElementById('weeklyChart').getContext('2d');
                
                if (this.charts.weekly) {
                    this.charts.weekly.destroy();
                }

                const dateCounts = {};
                this.filteredData.forEach(item => {
                    const date = item.question.date;
                    dateCounts[date] = (dateCounts[date] || 0) + 1;
                });

                const sortedDates = Object.entries(dateCounts).sort((a, b) => a[0].localeCompare(b[0]));

                this.charts.weekly = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates.map(([date]) => date),
                        datasets: [{
                            label: 'Questions per Day',
                            data: sortedDates.map(([, count]) => count),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            updateWeeklyAnalytics() {
                // Calculate day-of-week patterns
                const dayPattern = {};
                const typeByDay = {};
                
                this.filteredData.forEach(item => {
                    const date = new Date(item.question.date);
                    const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][date.getDay()];
                    
                    dayPattern[dayName] = (dayPattern[dayName] || 0) + 1;
                    
                    if (!typeByDay[dayName]) {
                        typeByDay[dayName] = { oral: 0, written: 0 };
                    }
                    typeByDay[dayName][item.question.questionType] = (typeByDay[dayName][item.question.questionType] || 0) + 1;
                });

                // Find peak day
                const peakDay = Object.entries(dayPattern).sort((a, b) => b[1] - a[1])[0];
                if (peakDay) {
                    document.getElementById('peakDay').textContent = peakDay[0];
                }

                // Calculate weekly average
                const totalQuestions = this.filteredData.length;
                const uniqueDates = new Set(this.filteredData.map(item => item.question.date)).size;
                const weeklyAvg = Math.round((totalQuestions / uniqueDates) * 7);
                document.getElementById('weeklyAvg').textContent = weeklyAvg;

                // Update daily pattern chart
                this.updateDailyPatternChart(dayPattern);
                this.updateTypeByDayChart(typeByDay);
            }

            updateDailyPatternChart(dayPattern) {
                const ctx = document.getElementById('dailyPatternChart').getContext('2d');
                
                if (this.charts.dailyPattern) {
                    this.charts.dailyPattern.destroy();
                }

                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const data = days.map(day => dayPattern[day] || 0);

                this.charts.dailyPattern = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: days,
                        datasets: [{
                            label: 'Questions per Day',
                            data: data,
                            backgroundColor: '#8b5cf6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            updateTypeByDayChart(typeByDay) {
                const ctx = document.getElementById('typeByDayChart').getContext('2d');
                
                if (this.charts.typeByDay) {
                    this.charts.typeByDay.destroy();
                }

                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const oralData = days.map(day => typeByDay[day]?.oral || 0);
                const writtenData = days.map(day => typeByDay[day]?.written || 0);

                this.charts.typeByDay = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: days,
                        datasets: [
                            {
                                label: 'Oral Questions',
                                data: oralData,
                                backgroundColor: '#10b981'
                            },
                            {
                                label: 'Written Questions',
                                data: writtenData,
                                backgroundColor: '#3b82f6'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            updateQuestionsTable() {
                const container = document.getElementById('questionsTable');
                
                let dataToShow = this.filteredData;
                
                // If deputy is selected, show only their 10 latest questions
                if (this.selectedDeputy) {
                    dataToShow = this.filteredData
                        .filter(item => item.question.by.showAs === this.selectedDeputy)
                        .sort((a, b) => new Date(b.question.date) - new Date(a.question.date))
                        .slice(0, 10);
                } else {
                    dataToShow = this.filteredData.slice(0, 50);
                }
                
                if (dataToShow.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">No questions found matching the current filters.</div>';
                    return;
                }
                
                const table = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deputy</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Question</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${dataToShow.map((item, index) => `
                                <tr class="hover:bg-gray-50 cursor-pointer" onclick="dashboard.showQuestionDetails(${this.filteredData.indexOf(item)})">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.question.date}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${this.selectedDeputy === item.question.by.showAs ? 'font-bold text-green-600' : ''}">${item.question.by.showAs}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.question.to?.showAs || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${item.question.questionType === 'oral' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                            ${item.question.questionType}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-900 max-w-md truncate">${item.question.showAs}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <button class="text-indigo-600 hover:text-indigo-900" onclick="event.stopPropagation(); window.open('${item.question.uri}', '_blank')">
                                            <i class="fas fa-external-link-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                container.innerHTML = table;
            }

            openWordCloudModal() {
                const modal = document.getElementById('wordCloudModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                this.generateWordCloud();
            }

            generateWordCloud() {
                const department = document.getElementById('wordCloudDepartment').value;
                const container = document.getElementById('wordCloudContainer');
                
                let dataForCloud = this.filteredData;
                if (department) {
                    dataForCloud = this.filteredData.filter(item => item.question.to?.showAs === department);
                }

                // Extract words from questions
                const allText = dataForCloud.map(item => item.question.showAs).join(' ');
                const words = this.extractWords(allText);
                
                // Create simple word cloud visualization
                const wordCloudHtml = this.createWordCloudHtml(words.slice(0, 50));
                container.innerHTML = wordCloudHtml;
            }

            extractWords(text) {
                const stopwords = new Set([
                    'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'up', 'about', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'over', 'under', 'again', 'further', 'then', 'once',
                    'a', 'an', 'as', 'are', 'was', 'were', 'been', 'be', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'can', 'may', 'might', 'must',
                    'i', 'me', 'my', 'myself', 'we', 'our', 'ours', 'ourselves', 'you', 'your', 'yours', 'yourself', 'yourselves', 'he', 'him', 'his', 'himself', 'she', 'her', 'hers', 'herself', 'it', 'its', 'itself', 'they', 'them', 'their', 'theirs', 'themselves',
                    'what', 'which', 'who', 'whom', 'this', 'that', 'these', 'those', 'am', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'having', 'do', 'does', 'did', 'doing',
                    'if', 'because', 'while', 'when', 'where', 'why', 'how', 'all', 'any', 'both', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than', 'too', 'very'
                ]);

                const words = text.toLowerCase()
                    .replace(/[^\w\s]/g, ' ')
                    .split(/\s+/)
                    .filter(word => word.length > 2 && !stopwords.has(word));

                const wordCount = {};
                words.forEach(word => {
                    wordCount[word] = (wordCount[word] || 0) + 1;
                });

                return Object.entries(wordCount)
                    .sort((a, b) => b[1] - a[1])
                    .map(([word, count]) => ({ word, count }));
            }

            createWordCloudHtml(words) {
                if (words.length === 0) {
                    return '<div class="text-center py-8 text-gray-500">No meaningful words found for word cloud generation.</div>';
                }

                const maxCount = words[0].count;
                const minSize = 12;
                const maxSize = 48;

                const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316', '#ec4899'];

                return `
                    <div class="flex flex-wrap justify-center items-center gap-2 p-4">
                        ${words.map((item, index) => {
                            const size = minSize + ((item.count / maxCount) * (maxSize - minSize));
                            const color = colors[index % colors.length];
                            return `<span style="font-size: ${size}px; color: ${color}; font-weight: ${item.count > maxCount/2 ? 'bold' : 'normal'};" 
                                         class="hover:opacity-75 cursor-pointer transition-opacity" 
                                         title="${item.word}: ${item.count} occurrences"
                                         onclick="dashboard.searchWord('${item.word}')">${item.word}</span>`;
                        }).join('')}
                    </div>
                `;
            }

            searchWord(word) {
                document.getElementById('searchInput').value = word;
                this.closeWordCloudModal();
                this.applyFilters();
            }

            showQuestionDetails(index) {
                const question = this.filteredData[index];
                const modal = document.getElementById('questionModal');
                const content = document.getElementById('modalContent');

                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-gray-800">Deputy</h4>
                                <p class="text-gray-600">${question.question.by.showAs}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">Department</h4>
                                <p class="text-gray-600">${question.question.to?.showAs || 'N/A'}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">Date</h4>
                                <p class="text-gray-600">${question.question.date}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">Type</h4>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${question.question.questionType === 'oral' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                    ${question.question.questionType}
                                </span>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">Full Question</h4>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-gray-700 leading-relaxed">${question.question.showAs}</p>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button onclick="window.open('${question.question.uri}', '_blank')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-external-link-alt mr-2"></i>View on Oireachtas.ie
                            </button>
                        </div>
                    </div>
                `;

                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            closeModal() {
                const modal = document.getElementById('questionModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            closeWordCloudModal() {
                const modal = document.getElementById('wordCloudModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            clearAllFilters() {
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
                document.getElementById('departmentFilter').value = '';
                document.getElementById('deputyFilter').value = '';
                document.getElementById('typeFilter').value = '';
                document.getElementById('searchInput').value = '';
                this.clearDeputySearch();
                this.applyFilters();
            }

            setupAutoRefresh() {
                const selectedValue = document.querySelector('input[name="autoRefresh"]:checked').value;
                
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }

                if (selectedValue !== '0') {
                    const interval = parseInt(selectedValue);
                    this.refreshInterval = setInterval(() => this.fetchData(), interval);
                    this.updateRefreshTimer(interval);
                } else {
                    document.getElementById('refreshTimer').textContent = '';
                }
            }

            updateRefreshTimer(interval) {
                let timeLeft = interval;
                const timer = setInterval(() => {
                    timeLeft -= 1000;
                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);
                    document.getElementById('refreshTimer').textContent = `Next refresh in ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                    }
                }, 1000);
            }

            exportData(format) {
                const data = this.filteredData.map(item => ({
                    date: item.question.date,
                    deputy: item.question.by.showAs,
                    department: item.question.to?.showAs || '',
                    type: item.question.questionType,
                    question: item.question.showAs,
                    uri: item.question.uri
                }));

                if (format === 'csv') {
                    const csv = this.convertToCSV(data);
                    this.downloadFile(csv, 'parliamentary-questions.csv', 'text/csv');
                } else if (format === 'json') {
                    const json = JSON.stringify(data, null, 2);
                    this.downloadFile(json, 'parliamentary-questions.json', 'application/json');
                }
            }

            convertToCSV(data) {
                if (data.length === 0) return '';
                
                const headers = Object.keys(data[0]);
                const csvContent = [
                    headers.join(','),
                    ...data.map(row => 
                        headers.map(header => 
                            `"${(row[header] || '').toString().replace(/"/g, '""')}"`
                        ).join(',')
                    )
                ].join('\n');
                
                return csvContent;
            }

            downloadFile(content, filename, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                if (show) {
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');
                } else {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                }
            }

            showError(message) {
                alert(message);
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }

        // Initialize the dashboard
        const dashboard = new ParliamentaryDashboard();
        window.dashboard = dashboard; // Make it globally accessible for onclick handlers
    </script>
</body>
</html>