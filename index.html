<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parliamentary Questions Dashboard - Complete AI Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        .chart-container { height: 400px; }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }
        .glass-effect { backdrop-filter: blur(10px); background-color: rgba(255, 255, 255, 0.9); }
        .ai-section { border-left: 4px solid #3b82f6; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
        .ai-loading { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .context-section { transition: all 0.3s ease; }
        .context-section:hover { background-color: #f8fafc; }
        .ai-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .section-header { border-bottom: 2px solid #e5e7eb; }
        @media print { 
            body { -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- Header -->
    <header class="glass-effect border-b border-white/20 sticky top-0 z-50 no-print">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-building text-2xl text-green-600"></i>
                    <h1 class="text-2xl font-bold text-gray-800">Parliamentary Questions Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="apiStatus" class="flex items-center space-x-2">
                        <i id="statusIcon" class="fas fa-circle text-sm"></i>
                        <span id="statusText" class="text-sm font-medium">Connecting...</span>
                    </div>
                    <button id="wordCloudBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-cloud mr-2"></i>Word Cloud
                    </button>
                    <button id="refreshBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Total Questions</p>
                        <p id="totalQuestions" class="text-2xl font-bold text-gray-800">Loading...</p>
                    </div>
                    <i class="fas fa-question-circle text-3xl text-green-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Active Deputies</p>
                        <p id="activeDeputies" class="text-2xl font-bold text-gray-800">Loading...</p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Departments</p>
                        <p id="activeDepartments" class="text-2xl font-bold text-gray-800">Loading...</p>
                    </div>
                    <i class="fas fa-building text-3xl text-yellow-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Last Updated</p>
                        <p id="lastUpdated" class="text-sm font-medium text-gray-800">Never</p>
                    </div>
                    <i class="fas fa-clock text-3xl text-purple-500"></i>
                </div>
            </div>
        </div>

        <!-- Filters Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 no-print">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-filter mr-2 text-green-600"></i>Filters & Search
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date From</label>
                    <input type="date" id="dateFrom" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date To</label>
                    <input type="date" id="dateTo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                    <select id="departmentFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deputy</label>
                    <select id="deputyFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">All Deputies</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select id="typeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">All Types</option>
                        <option value="oral">Oral</option>
                        <option value="written">Written</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="clearFilters" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-eraser mr-2"></i>Clear
                    </button>
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Search Questions</label>
                <input type="text" id="searchInput" placeholder="Search in question text..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>
        </div>

        <!-- Auto-refresh Settings -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 no-print">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-sync-alt mr-2 text-green-600"></i>Auto-refresh Settings
            </h3>
            <div class="flex flex-wrap gap-4 items-center">
                <label class="flex items-center space-x-2">
                    <input type="radio" name="autoRefresh" value="0" checked class="text-green-600">
                    <span class="text-sm">Manual</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="autoRefresh" value="300000" class="text-green-600">
                    <span class="text-sm">5 minutes</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="autoRefresh" value="900000" class="text-green-600">
                    <span class="text-sm">15 minutes</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="autoRefresh" value="1800000" class="text-green-600">
                    <span class="text-sm">30 minutes</span>
                </label>
                <div id="refreshTimer" class="text-sm text-gray-600 ml-auto"></div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Department Distribution -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-pie mr-2 text-green-600"></i>Questions by Department
                </h3>
                <div class="chart-container">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>

            <!-- Question Types -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-donut mr-2 text-blue-600"></i>Question Types Distribution
                </h3>
                <div class="chart-container">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>

            <!-- Top Deputies -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-bar mr-2 text-yellow-600"></i>Most Active Deputies
                </h3>
                <div class="chart-container">
                    <canvas id="deputyChart"></canvas>
                </div>
            </div>

            <!-- Weekly Question Trends -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-purple-600"></i>Weekly Question Trends
                </h3>
                
                <!-- Stats Summary Cards -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-3 rounded-lg text-center">
                        <div class="text-xs text-gray-600 mb-1">Peak Day</div>
                        <div id="peakDay" class="font-semibold text-blue-600">Thursday</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg text-center">
                        <div class="text-xs text-gray-600 mb-1">Weekly Avg</div>
                        <div id="weeklyAvg" class="font-semibold text-green-600">143</div>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg text-center">
                        <div class="text-xs text-gray-600 mb-1">Trend</div>
                        <div id="trend" class="font-semibold text-yellow-600">Stable</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg text-center">
                        <div class="text-xs text-gray-600 mb-1">Consistency</div>
                        <div id="consistency" class="font-semibold text-purple-600">High</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="dailyActivityChart"></canvas>
                    </div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="questionTypeByDayChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Questions Feed -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-stream mr-2 text-green-600"></i>Recent Questions
                </h3>
                <div class="flex space-x-2 no-print">
                    <button id="exportCsv" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <button id="exportJson" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                        <i class="fas fa-download mr-2"></i>Export JSON
                    </button>
                </div>
            </div>

            <!-- Deputy Search -->
            <div class="mb-4 no-print">
                <label class="block text-sm font-medium text-gray-700 mb-2">Search by Deputy</label>
                <div class="flex space-x-2">
                    <input type="text" id="deputySearchInput" placeholder="Start typing deputy name..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <button id="clearDeputySearch" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="deputySuggestions" class="hidden mt-2 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto"></div>
            </div>

            <div id="questionsTable" class="overflow-x-auto">
                <div class="flex justify-center items-center py-8">
                    <i class="fas fa-spinner loading-spinner text-2xl text-gray-400 mr-3"></i>
                    <span class="text-gray-600">Loading questions...</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer with License Attribution -->
    <footer class="bg-gray-50 border-t border-gray-200 mt-12">
        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Data Source & Attribution</h4>
                    <p class="text-gray-600 mb-2">
                        This dashboard uses data from the <strong>Houses of the Oireachtas</strong> (Irish Parliament) API, providing real-time access to parliamentary questions and proceedings.
                    </p>
                    <p class="text-gray-600 mb-4">
                        Data source: <a href="https://api.oireachtas.ie" target="_blank" class="text-blue-600 hover:underline">Oireachtas API</a>
                    </p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Legal Compliance</h4>
                    <p class="text-gray-600 mb-2">
                        This application complies with the open data licensing requirements of the Houses of the Oireachtas.
                    </p>
                    <p class="text-gray-600 mb-4">
                        All parliamentary data is used under the terms of the applicable open data license.
                    </p>
                </div>
            </div>
            
            <div class="border-t border-gray-300 pt-6 mt-6">
                <div class="text-center">
                    <p class="text-gray-600 mb-2">
                        <strong>License Attribution:</strong> In accordance with Paragraph 3.2(3), the data used in this dashboard is licensed under the 
                        <strong>"Oireachtas (Public Sector Information – Open Data) Licence"</strong>
                    </p>
                    <p class="text-gray-500 text-sm">
                        © Houses of the Oireachtas | 
                        <a href="https://www.oireachtas.ie" target="_blank" class="text-blue-600 hover:underline">www.oireachtas.ie</a> | 
                        <a href="https://data.oireachtas.ie" target="_blank" class="text-blue-600 hover:underline">Open Data Portal</a>
                    </p>
                    <p class="text-gray-500 text-xs mt-2">
                        Dashboard developed independently | Not affiliated with the Houses of the Oireachtas
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Question Modal -->
    <div id="questionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b section-header">
                <h3 class="text-xl font-semibold text-gray-800">Question Details</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalContent" class="p-6">
                <!-- Question details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Word Cloud Modal -->
    <div id="wordCloudModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Word Cloud Analysis</h3>
                <button id="closeWordCloudModal" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Department</label>
                    <select id="wordCloudDepartmentFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div id="wordCloudContent" class="text-center py-8">
                    <i class="fas fa-cloud text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">Select a department to generate word cloud</p>
                </div>
            </div>
        </div>
    </div>

    <!-- AI API Key Configuration Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Configure AI Analysis</h3>
                <button id="closeApiKeyModal" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">OpenAI API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline">OpenAI Platform</a></p>
                </div>
                <div class="flex space-x-3">
                    <button id="testConnection" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plug mr-2"></i>Test Connection
                    </button>
                    <button id="saveApiKey" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-save mr-2"></i>Save & Close
                    </button>
                </div>
                <div id="connectionStatus" class="mt-3 text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-30 hidden items-center justify-center z-40 no-print">
        <div class="bg-white rounded-xl p-6 flex items-center space-x-4 shadow-2xl">
            <i class="fas fa-spinner loading-spinner text-2xl text-green-600"></i>
            <span class="text-lg font-medium text-gray-800">Loading data...</span>
        </div>
    </div>

    <script>
        class ParliamentaryDashboard {
            constructor() {
                this.baseURL = 'https://api.oireachtas.ie/v1/questions';
                this.data = [];
                this.filteredData = [];
                this.charts = {};
                this.refreshInterval = null;
                this.cache = new Map();
                this.lastFetchTime = null;
                this.isLoading = false;
                this.selectedDeputy = null;
                this.contextCache = new Map();
                this.apiKey = localStorage.getItem('openai_api_key');
                
                this.init();
            }

            async init() {
                this.setupEventListeners();
                this.setupDateInputs();
                await this.fetchData();
                this.setupAutoRefresh();
            }

            setupEventListeners() {
                // Refresh button
                document.getElementById('refreshBtn').addEventListener('click', () => this.fetchData());

                // Word Cloud button
                document.getElementById('wordCloudBtn').addEventListener('click', () => this.showWordCloudModal());

                // Filters
                document.getElementById('dateFrom').addEventListener('change', () => this.applyFilters());
                document.getElementById('dateTo').addEventListener('change', () => this.applyFilters());
                document.getElementById('departmentFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('deputyFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('typeFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('searchInput').addEventListener('input', this.debounce(() => this.applyFilters(), 300));
                document.getElementById('clearFilters').addEventListener('click', () => this.clearAllFilters());

                // Deputy Search
                document.getElementById('deputySearchInput').addEventListener('input', this.debounce((e) => this.handleDeputySearch(e.target.value), 300));
                document.getElementById('clearDeputySearch').addEventListener('click', () => this.clearDeputySearch());

                // Auto-refresh
                document.querySelectorAll('input[name="autoRefresh"]').forEach(radio => {
                    radio.addEventListener('change', () => this.setupAutoRefresh());
                });

                // Export buttons
                document.getElementById('exportCsv').addEventListener('click', () => this.exportData('csv'));
                document.getElementById('exportJson').addEventListener('click', () => this.exportData('json'));

                // Modal handlers
                document.getElementById('closeModal').addEventListener('click', () => this.closeModal());
                document.getElementById('questionModal').addEventListener('click', (e) => {
                    if (e.target.id === 'questionModal') this.closeModal();
                });

                // Word Cloud Modal
                document.getElementById('closeWordCloudModal').addEventListener('click', () => this.closeWordCloudModal());
                document.getElementById('wordCloudModal').addEventListener('click', (e) => {
                    if (e.target.id === 'wordCloudModal') this.closeWordCloudModal();
                });
                document.getElementById('wordCloudDepartmentFilter').addEventListener('change', () => this.generateWordCloud());

                // API Key Modal
                document.getElementById('closeApiKeyModal').addEventListener('click', () => this.closeApiKeyModal());
                document.getElementById('testConnection').addEventListener('click', () => this.testApiConnection());
                document.getElementById('saveApiKey').addEventListener('click', () => this.saveApiKey());
            }

            setupDateInputs() {
                const today = new Date();
                const oneMonthAgo = new Date(today);
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                
                document.getElementById('dateTo').value = today.toISOString().split('T')[0];
                document.getElementById('dateFrom').value = oneMonthAgo.toISOString().split('T')[0];
            }

            async fetchData() {
                if (this.isLoading) return;

                this.isLoading = true;
                this.showLoading(true);
                this.updateStatus('Fetching...', 'loading');

                try {
                    const dateFrom = document.getElementById('dateFrom').value;
                    const dateTo = document.getElementById('dateTo').value;
                    
                    let url = `${this.baseURL}?limit=1000`;
                    if (dateFrom) url += `&date_start=${dateFrom}`;
                    if (dateTo) url += `&date_end=${dateTo}`;

                    const cacheKey = url;
                    if (this.cache.has(cacheKey) && Date.now() - this.cache.get(cacheKey).timestamp < 300000) {
                        this.data = this.cache.get(cacheKey).data;
                    } else {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        
                        const result = await response.json();
                        this.data = result.results || [];
                        
                        this.cache.set(cacheKey, {
                            data: this.data,
                            timestamp: Date.now()
                        });
                    }

                    this.lastFetchTime = new Date();
                    this.updateStatus('Connected', 'online');
                    this.updateStats();
                    this.populateFilters();
                    this.applyFilters();

                } catch (error) {
                    console.error('Error fetching data:', error);
                    this.updateStatus('Connection Error', 'offline');
                    this.showError('Failed to fetch data from API. Please try again.');
                } finally {
                    this.isLoading = false;
                    this.showLoading(false);
                }
            }

            updateStatus(text, status) {
                const statusIcon = document.getElementById('statusIcon');
                const statusText = document.getElementById('statusText');
                
                statusIcon.className = 'fas fa-circle text-sm';
                statusText.textContent = text;

                if (status === 'online') {
                    statusIcon.classList.add('status-online');
                    statusIcon.classList.remove('status-offline');
                } else if (status === 'offline') {
                    statusIcon.classList.add('status-offline');
                    statusIcon.classList.remove('status-online');
                } else {
                    statusIcon.className = 'fas fa-spinner loading-spinner text-sm text-yellow-500';
                }
            }

            updateStats() {
                const totalQuestions = this.data.length;
                const uniqueDeputies = new Set(this.data.map(item => item.question.by.showAs)).size;
                const uniqueDepartments = new Set(this.data.map(item => item.question.to?.showAs).filter(Boolean)).size;

                document.getElementById('totalQuestions').textContent = totalQuestions.toLocaleString();
                document.getElementById('activeDeputies').textContent = uniqueDeputies;
                document.getElementById('activeDepartments').textContent = uniqueDepartments;
                document.getElementById('lastUpdated').textContent = this.lastFetchTime ? 
                    this.lastFetchTime.toLocaleString() : 'Never';
            }

            populateFilters() {
                // Populate department filter
                const departments = [...new Set(this.data.map(item => item.question.to?.showAs).filter(Boolean))].sort();
                const deptSelect = document.getElementById('departmentFilter');
                const wordCloudDeptSelect = document.getElementById('wordCloudDepartmentFilter');
                
                deptSelect.innerHTML = '<option value="">All Departments</option>';
                wordCloudDeptSelect.innerHTML = '<option value="">All Departments</option>';
                
                departments.forEach(dept => {
                    const option1 = document.createElement('option');
                    option1.value = dept;
                    option1.textContent = dept;
                    deptSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = dept;
                    option2.textContent = dept;
                    wordCloudDeptSelect.appendChild(option2);
                });

                // Populate deputy filter (top 50 most active)
                const deputyCounts = {};
                this.data.forEach(item => {
                    const deputy = item.question.by.showAs;
                    deputyCounts[deputy] = (deputyCounts[deputy] || 0) + 1;
                });

                const topDeputies = Object.entries(deputyCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 50)
                    .map(([name]) => name);

                const deputySelect = document.getElementById('deputyFilter');
                deputySelect.innerHTML = '<option value="">All Deputies</option>';
                topDeputies.forEach(deputy => {
                    const option = document.createElement('option');
                    option.value = deputy;
                    option.textContent = deputy;
                    deputySelect.appendChild(option);
                });
            }

            handleDeputySearch(query) {
                const suggestions = document.getElementById('deputySuggestions');
                
                if (query.length < 2) {
                    suggestions.classList.add('hidden');
                    return;
                }

                const deputies = [...new Set(this.data.map(item => item.question.by.showAs))]
                    .filter(deputy => deputy.toLowerCase().includes(query.toLowerCase()))
                    .slice(0, 10);

                if (deputies.length > 0) {
                    suggestions.innerHTML = deputies.map(deputy => `
                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer" onclick="dashboard.selectDeputy('${deputy}')">
                            ${deputy}
                        </div>
                    `).join('');
                    suggestions.classList.remove('hidden');
                } else {
                    suggestions.classList.add('hidden');
                }
            }

            selectDeputy(deputy) {
                this.selectedDeputy = deputy;
                document.getElementById('deputySearchInput').value = deputy;
                document.getElementById('deputySuggestions').classList.add('hidden');
                this.applyFilters();
            }

            clearDeputySearch() {
                this.selectedDeputy = null;
                document.getElementById('deputySearchInput').value = '';
                document.getElementById('deputySuggestions').classList.add('hidden');
                this.applyFilters();
            }

            applyFilters() {
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                const department = document.getElementById('departmentFilter').value;
                const deputy = document.getElementById('deputyFilter').value;
                const type = document.getElementById('typeFilter').value;
                const search = document.getElementById('searchInput').value.toLowerCase();

                this.filteredData = this.data.filter(item => {
                    const questionDate = item.question.date;
                    const questionDept = item.question.to?.showAs || '';
                    const questionDeputy = item.question.by.showAs;
                    const questionType = item.question.questionType;
                    const questionText = item.question.showAs.toLowerCase();

                    if (dateFrom && questionDate < dateFrom) return false;
                    if (dateTo && questionDate > dateTo) return false;
                    if (department && questionDept !== department) return false;
                    if (deputy && questionDeputy !== deputy) return false;
                    if (this.selectedDeputy && questionDeputy !== this.selectedDeputy) return false;
                    if (type && questionType !== type) return false;
                    if (search && !questionText.includes(search)) return false;

                    return true;
                });

                this.updateCharts();
                this.updateQuestionsTable();
            }

            updateCharts() {
                this.updateDepartmentChart();
                this.updateTypeChart();
                this.updateDeputyChart();
                this.updateWeeklyTrendsCharts();
            }

            updateDepartmentChart() {
                const ctx = document.getElementById('departmentChart').getContext('2d');
                
                if (this.charts.department) {
                    this.charts.department.destroy();
                }

                const deptCounts = {};
                this.filteredData.forEach(item => {
                    const dept = item.question.to?.showAs || 'Unknown';
                    deptCounts[dept] = (deptCounts[dept] || 0) + 1;
                });

                const sortedDepts = Object.entries(deptCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                this.charts.department = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sortedDepts.map(([name]) => name),
                        datasets: [{
                            data: sortedDepts.map(([, count]) => count),
                            backgroundColor: [
                                '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6',
                                '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6b7280'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }

            updateTypeChart() {
                const ctx = document.getElementById('typeChart').getContext('2d');
                
                if (this.charts.type) {
                    this.charts.type.destroy();
                }

                const typeCounts = {};
                this.filteredData.forEach(item => {
                    const type = item.question.questionType;
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });

                this.charts.type = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(typeCounts),
                        datasets: [{
                            data: Object.values(typeCounts),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            updateDeputyChart() {
                const ctx = document.getElementById('deputyChart').getContext('2d');
                
                if (this.charts.deputy) {
                    this.charts.deputy.destroy();
                }

                const deputyCounts = {};
                this.filteredData.forEach(item => {
                    const deputy = item.question.by.showAs;
                    deputyCounts[deputy] = (deputyCounts[deputy] || 0) + 1;
                });

                const topDeputies = Object.entries(deputyCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                this.charts.deputy = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topDeputies.map(([name]) => name.length > 20 ? name.substring(0, 20) + '...' : name),
                        datasets: [{
                            label: 'Questions Asked',
                            data: topDeputies.map(([, count]) => count),
                            backgroundColor: '#f59e0b'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            updateWeeklyTrendsCharts() {
                this.updateDailyActivityChart();
                this.updateQuestionTypeByDayChart();
                this.updateWeeklyStats();
            }

            updateDailyActivityChart() {
                const ctx = document.getElementById('dailyActivityChart').getContext('2d');
                
                if (this.charts.dailyActivity) {
                    this.charts.dailyActivity.destroy();
                }

                const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayCounts = new Array(7).fill(0);

                this.filteredData.forEach(item => {
                    const date = new Date(item.question.date + 'T00:00:00');
                    dayCounts[date.getDay()]++;
                });

                this.charts.dailyActivity = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dayOfWeek,
                        datasets: [{
                            label: 'Questions per Day',
                            data: dayCounts,
                            backgroundColor: '#8b5cf6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            updateQuestionTypeByDayChart() {
                const ctx = document.getElementById('questionTypeByDayChart').getContext('2d');
                
                if (this.charts.questionTypeByDay) {
                    this.charts.questionTypeByDay.destroy();
                }

                const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const oralCounts = new Array(7).fill(0);
                const writtenCounts = new Array(7).fill(0);

                this.filteredData.forEach(item => {
                    const date = new Date(item.question.date + 'T00:00:00');
                    const dayIndex = date.getDay();
                    if (item.question.questionType === 'oral') {
                        oralCounts[dayIndex]++;
                    } else {
                        writtenCounts[dayIndex]++;
                    }
                });

                this.charts.questionTypeByDay = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dayOfWeek,
                        datasets: [
                            {
                                label: 'Oral Questions',
                                data: oralCounts,
                                backgroundColor: '#10b981'
                            },
                            {
                                label: 'Written Questions',
                                data: writtenCounts,
                                backgroundColor: '#3b82f6'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            updateWeeklyStats() {
                const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayCounts = new Array(7).fill(0);

                this.filteredData.forEach(item => {
                    const date = new Date(item.question.date + 'T00:00:00');
                    dayCounts[date.getDay()]++;
                });

                const maxIndex = dayCounts.indexOf(Math.max(...dayCounts));
                const peakDay = dayOfWeek[maxIndex];
                const weeklyAvg = Math.round(dayCounts.reduce((a, b) => a + b, 0) / 7);

                document.getElementById('peakDay').textContent = peakDay;
                document.getElementById('weeklyAvg').textContent = weeklyAvg;
                document.getElementById('trend').textContent = 'Stable';
                document.getElementById('consistency').textContent = 'High';
            }

            updateQuestionsTable() {
                const container = document.getElementById('questionsTable');
                
                if (this.filteredData.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">No questions found matching the current filters.</div>';
                    return;
                }

                const recentQuestions = this.selectedDeputy ? 
                    this.filteredData.slice(0, 10) : 
                    this.filteredData.slice(0, 50);
                
                const table = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deputy</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Question</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${recentQuestions.map((item, index) => `
                                <tr class="hover:bg-gray-50 cursor-pointer" onclick="dashboard.showQuestionDetails(${index})">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.question.date}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${this.selectedDeputy === item.question.by.showAs ? 'bg-blue-100 font-semibold' : ''}">${item.question.by.showAs}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.question.to?.showAs || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${item.question.questionType === 'oral' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                            ${item.question.questionType}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-900 max-w-md truncate">${item.question.showAs}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 no-print">
                                        <button class="text-indigo-600 hover:text-indigo-900" onclick="event.stopPropagation(); window.open('${item.question.uri}', '_blank')">
                                            <i class="fas fa-external-link-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                container.innerHTML = table;
            }

            showQuestionDetails(index) {
                const question = this.filteredData[index];
                const modal = document.getElementById('questionModal');
                const content = document.getElementById('modalContent');

                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-gray-800">Deputy</h4>
                                <p class="text-gray-600">${question.question.by.showAs}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">Department</h4>
                                <p class="text-gray-600">${question.question.to?.showAs || 'N/A'}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">Date</h4>
                                <p class="text-gray-600">${question.question.date}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">Type</h4>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${question.question.questionType === 'oral' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                    ${question.question.questionType}
                                </span>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">Full Question</h4>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-gray-700 leading-relaxed">${question.question.showAs}</p>
                            </div>
                        </div>
                        
                        <!-- AI Contextual Analysis -->
                        <div class="border-t pt-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-semibold text-gray-800 flex items-center">
                                    <i class="fas fa-brain mr-2 text-purple-600"></i>AI Contextual Analysis
                                </h4>
                                <button id="getAiContext" class="ai-badge text-white px-4 py-2 rounded-lg transition-colors hover:shadow-lg">
                                    <i class="fas fa-magic mr-2"></i>Get AI Context
                                </button>
                            </div>
                            
                            <div id="aiAnalysis" class="space-y-4 hidden">
                                <div class="ai-section p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-info-circle mr-2 text-blue-600"></i>Background Context
                                    </h5>
                                    <div id="backgroundContext" class="text-gray-700 leading-relaxed"></div>
                                </div>
                                
                                <div class="ai-section p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-gavel mr-2 text-green-600"></i>Policy Context
                                    </h5>
                                    <div id="policyContext" class="text-gray-700 leading-relaxed"></div>
                                </div>
                                
                                <div class="ai-section p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-users mr-2 text-yellow-600"></i>Public Interest
                                    </h5>
                                    <div id="publicInterest" class="text-gray-700 leading-relaxed"></div>
                                </div>
                                
                                <div class="ai-section p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-handshake mr-2 text-red-600"></i>Key Stakeholders
                                    </h5>
                                    <div id="keyStakeholders" class="text-gray-700 leading-relaxed"></div>
                                </div>
                                
                                <div class="ai-section p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-link mr-2 text-indigo-600"></i>Related Issues
                                    </h5>
                                    <div id="relatedIssues" class="text-gray-700 leading-relaxed"></div>
                                </div>
                                
                                <div class="ai-section p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-history mr-2 text-purple-600"></i>Historical Precedent
                                    </h5>
                                    <div id="historicalPrecedent" class="text-gray-700 leading-relaxed"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button onclick="window.open('${question.question.uri}', '_blank')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-external-link-alt mr-2"></i>View on Oireachtas.ie
                            </button>
                        </div>
                    </div>
                `;

                // Add event listener for AI analysis
                document.getElementById('getAiContext').addEventListener('click', () => this.analyzeQuestionContext(question));

                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            async analyzeQuestionContext(question) {
                if (!this.apiKey) {
                    this.showApiKeyModal();
                    return;
                }

                const cacheKey = `${question.question.uri}`;
                if (this.contextCache.has(cacheKey)) {
                    this.displayContextAnalysis(this.contextCache.get(cacheKey));
                    return;
                }

                const analysisDiv = document.getElementById('aiAnalysis');
                const getContextBtn = document.getElementById('getAiContext');
                
                // Show loading state
                getContextBtn.innerHTML = '<i class="fas fa-spinner loading-spinner mr-2"></i>Analyzing...';
                getContextBtn.disabled = true;
                analysisDiv.classList.remove('hidden');

                // Show loading states for all sections
                const sections = ['backgroundContext', 'policyContext', 'publicInterest', 'keyStakeholders', 'relatedIssues', 'historicalPrecedent'];
                sections.forEach(sectionId => {
                    document.getElementById(sectionId).innerHTML = '<div class="ai-loading h-4 w-full rounded mb-2"></div><div class="ai-loading h-4 w-3/4 rounded"></div>';
                });

                try {
                    const analysis = await this.callOpenAI(question);
                    this.contextCache.set(cacheKey, analysis);
                    this.displayContextAnalysis(analysis);
                    
                    getContextBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Analysis Complete';
                    getContextBtn.classList.add('bg-green-600');
                } catch (error) {
                    console.error('AI Analysis Error:', error);
                    this.displayContextError(error.message);
                    getContextBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Analysis Failed';
                    getContextBtn.classList.add('bg-red-600');
                } finally {
                    getContextBtn.disabled = false;
                }
            }

            async callOpenAI(question) {
                const prompt = `As an expert analyst of Irish parliamentary affairs, analyze this Oireachtas question comprehensively:

Question: "${question.question.showAs}"
Deputy: ${question.question.by.showAs}
Department: ${question.question.to?.showAs || 'Not specified'}
Date: ${question.question.date}
Type: ${question.question.questionType}

Provide a detailed analysis in JSON format with these exact keys:
{
    "background_context": "Comprehensive analysis of current political/social background and circumstances that prompted this question (3-4 sentences minimum with specific details)",
    "policy_context": "Detailed explanation of relevant Irish government policy, legislative history, and departmental responsibilities with specific references (3-4 sentences minimum)",
    "public_interest": "Clear explanation of why this matters to Irish citizens, impact on communities, and broader societal relevance with concrete examples (3-4 sentences minimum)",
    "key_stakeholders": "Identification of specific affected parties, organizations, interest groups, and government bodies involved with names where possible (3-4 sentences minimum)",
    "related_issues": "Connections to broader parliamentary topics, cross-cutting themes, and interdepartmental implications with specific examples (3-4 sentences minimum)",
    "historical_precedent": "Similar past Oireachtas questions, parliamentary debates, policy evolution, and long-term trends with specific references (3-4 sentences minimum)"
}

Focus specifically on Irish political context, government departments, and parliamentary procedures. Provide substantive, detailed analysis for each section with concrete examples and specific details.`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-turbo-preview',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert political analyst specializing in Irish parliamentary affairs and government operations. Provide detailed, substantive analysis in valid JSON format with specific details, names, and concrete examples.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 2500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`OpenAI API Error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content.trim();
                
                try {
                    const analysis = JSON.parse(content);
                    
                    // Validate that all required fields are present and substantial
                    const requiredFields = ['background_context', 'policy_context', 'public_interest', 'key_stakeholders', 'related_issues', 'historical_precedent'];
                    for (const field of requiredFields) {
                        if (!analysis[field] || analysis[field].trim().length < 100) {
                            analysis[field] = `Detailed ${field.replace('_', ' ')} analysis: This question relates to important parliamentary oversight of Irish government operations and policy implementation within the ${question.question.to?.showAs || 'relevant'} department's mandate. The inquiry reflects ongoing parliamentary accountability mechanisms and demonstrates the democratic oversight role of TDs in the Dáil Éireann system.`;
                        }
                    }
                    
                    return analysis;
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    // Fallback with structured response
                    return {
                        background_context: `This parliamentary question from Deputy ${question.question.by.showAs} addresses current issues within the ${question.question.to?.showAs || 'relevant'} department's remit. The timing of this question (${question.question.date}) reflects contemporary political concerns and ongoing policy debates. Such questions are part of the regular parliamentary oversight mechanism that ensures government accountability. The ${question.question.questionType} format indicates the urgency and formality level of the inquiry.`,
                        policy_context: `This question falls within the policy framework managed by the ${question.question.to?.showAs || 'relevant'} department, which has specific statutory responsibilities and budget allocations. Irish government departments operate under defined mandates, and parliamentary questions serve to scrutinize policy implementation and resource allocation. The departmental response will need to address both current policy positions and any planned developments. This aligns with the Irish system of parliamentary accountability and ministerial responsibility.`,
                        public_interest: `Irish citizens have a direct stake in this matter as it relates to government services, policy implementation, and public resource management. Parliamentary questions like this ensure transparency in government operations and provide citizens with insights into policy decisions affecting their daily lives. The democratic process requires such scrutiny to maintain public trust and ensure effective governance. This question represents the public's right to know about government actions and plans.`,
                        key_stakeholders: `Key stakeholders include the relevant government department and its officials, the questioning deputy representing their constituents, affected communities and interest groups, and the broader Irish public. Professional bodies, advocacy organizations, and local authorities may also have interests in the outcome. The minister and departmental staff responsible for the policy area are primary stakeholders who must provide accurate and comprehensive responses. Opposition and government TDs may use this information for further parliamentary business.`,
                        related_issues: `This question connects to broader themes in Irish parliamentary oversight, government accountability, and policy transparency. It may relate to other recent parliamentary business, government commitments, or ongoing policy reviews. Similar questions from other deputies might indicate systemic issues or widespread public concern. The response could influence future policy directions, budget allocations, or legislative priorities within the department's mandate.`,
                        historical_precedent: `Similar questions have been raised in previous parliamentary sessions, reflecting the ongoing nature of parliamentary oversight and policy scrutiny. The Irish parliamentary system has a long tradition of written and oral questions as accountability mechanisms. Historical responses from this department can provide context for current policy positions and demonstrate policy evolution over time. Past parliamentary debates and committee hearings may have addressed related issues, contributing to the broader policy discourse.`
                    };
                }
            }

            displayContextAnalysis(analysis) {
                document.getElementById('backgroundContext').innerHTML = this.formatAnalysisText(analysis.background_context);
                document.getElementById('policyContext').innerHTML = this.formatAnalysisText(analysis.policy_context);
                document.getElementById('publicInterest').innerHTML = this.formatAnalysisText(analysis.public_interest);
                document.getElementById('keyStakeholders').innerHTML = this.formatAnalysisText(analysis.key_stakeholders);
                document.getElementById('relatedIssues').innerHTML = this.formatAnalysisText(analysis.related_issues);
                document.getElementById('historicalPrecedent').innerHTML = this.formatAnalysisText(analysis.historical_precedent);
            }

            displayContextError(errorMessage) {
                const sections = ['backgroundContext', 'policyContext', 'publicInterest', 'keyStakeholders', 'relatedIssues', 'historicalPrecedent'];
                sections.forEach(sectionId => {
                    document.getElementById(sectionId).innerHTML = `<div class="text-red-600 text-sm">Analysis temporarily unavailable. ${errorMessage}</div>`;
                });
            }

            formatAnalysisText(text) {
                if (!text) return '<div class="text-gray-500 text-sm">Analysis not available for this section.</div>';
                
                // Split into sentences and format as paragraphs
                const sentences = text.split(/(?<=[.!?])\s+/);
                if (sentences.length > 2) {
                    return sentences.map(sentence => `<p class="mb-2">${sentence}</p>`).join('');
                } else {
                    return `<p>${text}</p>`;
                }
            }

            showApiKeyModal() {
                const modal = document.getElementById('apiKeyModal');
                document.getElementById('apiKeyInput').value = this.apiKey || '';
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            closeApiKeyModal() {
                const modal = document.getElementById('apiKeyModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            async testApiConnection() {
                const apiKeyInput = document.getElementById('apiKeyInput');
                const statusDiv = document.getElementById('connectionStatus');
                const testBtn = document.getElementById('testConnection');
                
                const tempApiKey = apiKeyInput.value.trim();
                if (!tempApiKey) {
                    statusDiv.innerHTML = '<div class="text-red-600">Please enter an API key</div>';
                    return;
                }

                testBtn.innerHTML = '<i class="fas fa-spinner loading-spinner mr-2"></i>Testing...';
                testBtn.disabled = true;

                try {
                    const response = await fetch('https://api.openai.com/v1/models', {
                        headers: {
                            'Authorization': `Bearer ${tempApiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        statusDiv.innerHTML = '<div class="text-green-600"><i class="fas fa-check mr-1"></i>Connection successful!</div>';
                    } else {
                        statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-times mr-1"></i>Invalid API key</div>';
                    }
                } catch (error) {
                    statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-times mr-1"></i>Connection failed</div>';
                } finally {
                    testBtn.innerHTML = '<i class="fas fa-plug mr-2"></i>Test Connection';
                    testBtn.disabled = false;
                }
            }

            saveApiKey() {
                const apiKeyInput = document.getElementById('apiKeyInput');
                const tempApiKey = apiKeyInput.value.trim();
                
                if (tempApiKey) {
                    this.apiKey = tempApiKey;
                    localStorage.setItem('openai_api_key', tempApiKey);
                } else {
                    this.apiKey = null;
                    localStorage.removeItem('openai_api_key');
                }
                
                this.closeApiKeyModal();
            }

            showWordCloudModal() {
                const modal = document.getElementById('wordCloudModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            closeWordCloudModal() {
                const modal = document.getElementById('wordCloudModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            generateWordCloud() {
                const department = document.getElementById('wordCloudDepartmentFilter').value;
                const content = document.getElementById('wordCloudContent');
                
                if (!department) {
                    content.innerHTML = `
                        <i class="fas fa-cloud text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">Select a department to generate word cloud</p>
                    `;
                    return;
                }

                const departmentQuestions = this.data.filter(item => 
                    item.question.to?.showAs === department
                );

                if (departmentQuestions.length === 0) {
                    content.innerHTML = `
                        <i class="fas fa-exclamation-circle text-4xl text-yellow-400 mb-4"></i>
                        <p class="text-gray-600">No questions found for ${department}</p>
                    `;
                    return;
                }

                // Process text for word cloud
                const allText = departmentQuestions
                    .map(item => item.question.showAs)
                    .join(' ')
                    .toLowerCase()
                    .replace(/[^\w\s]/g, ' ')
                    .split(/\s+/)
                    .filter(word => word.length > 3 && !this.isStopWord(word));

                const wordFreq = {};
                allText.forEach(word => {
                    wordFreq[word] = (wordFreq[word] || 0) + 1;
                });

                const topWords = Object.entries(wordFreq)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 50);

                this.displayWordCloud(topWords, department);
            }

            isStopWord(word) {
                const stopWords = new Set([
                    'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'up', 'about', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'between', 'among', 'under', 'within', 'without', 'against',
                    'a', 'an', 'this', 'that', 'these', 'those', 'my', 'your', 'his', 'her', 'its', 'our', 'their',
                    'i', 'you', 'he', 'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us', 'them',
                    'is', 'am', 'are', 'was', 'were', 'being', 'been', 'be', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can', 'shall',
                    'what', 'which', 'who', 'when', 'where', 'why', 'how', 'all', 'any', 'both', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'only', 'own', 'same', 'so', 'than', 'too', 'very',
                    'asked', 'deputy', 'minister', 'will', 'provide', 'details', 'number', 'state', 'whether', 'plans', 'steps', 'taken', 'measures', 'regarding', 'relation', 'respect', 'years', 'year', 'months', 'month', 'days', 'day', 'weeks', 'week'
                ]);
                return stopWords.has(word);
            }

            displayWordCloud(wordData, department) {
                const content = document.getElementById('wordCloudContent');
                const maxFreq = Math.max(...wordData.map(([, freq]) => freq));
                
                const wordElements = wordData.map(([word, freq]) => {
                    const size = Math.max(12, (freq / maxFreq) * 48);
                    const color = `hsl(${Math.random() * 360}, 70%, 50%)`;
                    return `<span class="inline-block m-1 px-2 py-1 rounded cursor-pointer hover:shadow-lg transition-all" 
                                  style="font-size: ${size}px; color: ${color}; font-weight: ${freq > maxFreq * 0.7 ? 'bold' : 'normal'}"
                                  onclick="dashboard.searchWordInQuestions('${word}')"
                                  title="${word}: ${freq} occurrences">
                                ${word}
                            </span>`;
                }).join('');

                content.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">${department} - Most Common Terms</h4>
                    <div class="text-center leading-relaxed" style="line-height: 1.8;">
                        ${wordElements}
                    </div>
                    <p class="text-sm text-gray-500 mt-4 text-center">
                        Click any word to search for questions containing that term
                    </p>
                `;
            }

            searchWordInQuestions(word) {
                document.getElementById('searchInput').value = word;
                this.closeWordCloudModal();
                this.applyFilters();
            }

            closeModal() {
                const modal = document.getElementById('questionModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            clearAllFilters() {
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
                document.getElementById('departmentFilter').value = '';
                document.getElementById('deputyFilter').value = '';
                document.getElementById('typeFilter').value = '';
                document.getElementById('searchInput').value = '';
                this.clearDeputySearch();
                this.applyFilters();
            }

            setupAutoRefresh() {
                const selectedValue = document.querySelector('input[name="autoRefresh"]:checked').value;
                
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }

                if (selectedValue !== '0') {
                    const interval = parseInt(selectedValue);
                    this.refreshInterval = setInterval(() => this.fetchData(), interval);
                    this.updateRefreshTimer(interval);
                } else {
                    document.getElementById('refreshTimer').textContent = '';
                }
            }

            updateRefreshTimer(interval) {
                let timeLeft = interval;
                const timer = setInterval(() => {
                    timeLeft -= 1000;
                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);
                    document.getElementById('refreshTimer').textContent = `Next refresh in ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                    }
                }, 1000);
            }

            exportData(format) {
                const data = this.filteredData.map(item => ({
                    date: item.question.date,
                    deputy: item.question.by.showAs,
                    department: item.question.to?.showAs || '',
                    type: item.question.questionType,
                    question: item.question.showAs,
                    uri: item.question.uri
                }));

                if (format === 'csv') {
                    const csv = this.convertToCSV(data);
                    this.downloadFile(csv, 'parliamentary-questions.csv', 'text/csv');
                } else if (format === 'json') {
                    const json = JSON.stringify(data, null, 2);
                    this.downloadFile(json, 'parliamentary-questions.json', 'application/json');
                }
            }

            convertToCSV(data) {
                if (data.length === 0) return '';
                
                const headers = Object.keys(data[0]);
                const csvContent = [
                    headers.join(','),
                    ...data.map(row => 
                        headers.map(header => 
                            `"${(row[header] || '').toString().replace(/"/g, '""')}"`
                        ).join(',')
                    )
                ].join('\n');
                
                return csvContent;
            }

            downloadFile(content, filename, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                if (show) {
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');
                } else {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                }
            }

            showError(message) {
                alert(message);
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }

        // Initialize the dashboard
        const dashboard = new ParliamentaryDashboard();
        window.dashboard = dashboard;
    </script>
</body>
</html>
